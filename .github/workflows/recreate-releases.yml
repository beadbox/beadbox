name: Recreate releases as org identity

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  recreate:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4

      - name: Save release metadata
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"
          mkdir -p /tmp/release-data

          # Fetch all releases (oldest first) and save each as a separate JSON file
          gh api "repos/$REPO/releases" --paginate --jq 'reverse | .[]' | \
            jq -c '.' | nl -ba -nrz -w4 | while IFS=$'\t' read -r idx json; do
              echo "$json" > "/tmp/release-data/${idx}.json"
            done

          count=$(ls /tmp/release-data/*.json 2>/dev/null | wc -l | tr -d ' ')
          echo "Saved $count releases"
          ls /tmp/release-data/

      - name: Recreate all releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"

          total=$(ls /tmp/release-data/*.json | wc -l | tr -d ' ')
          count=0

          for f in /tmp/release-data/*.json; do
            count=$((count + 1))

            release_id=$(jq -r '.id' "$f")
            tag=$(jq -r '.tag_name' "$f")
            name=$(jq -r '.name // ""' "$f")
            is_draft=$(jq -r '.draft' "$f")
            is_prerelease=$(jq -r '.prerelease' "$f")
            asset_count=$(jq -r '.assets | length' "$f")

            echo ""
            echo "=== [$count/$total] $tag (id=$release_id, assets=$asset_count) ==="

            # Download assets
            rm -rf /tmp/assets && mkdir -p /tmp/assets
            if [ "$asset_count" -gt 0 ]; then
              echo "  Downloading assets..."
              jq -r '.assets[] | [.name, .url] | @tsv' "$f" | \
              while IFS=$'\t' read -r aname aurl; do
                echo "    $aname"
                gh api "$aurl" -H "Accept: application/octet-stream" > "/tmp/assets/$aname" || echo "    WARN: failed $aname"
              done
              downloaded=$(ls /tmp/assets/ 2>/dev/null | wc -l | tr -d ' ')
              echo "  Downloaded: $downloaded files"
            fi

            # Extract body to file
            jq -r '.body // ""' "$f" > /tmp/body.md

            # Delete old release
            echo "  Deleting release $release_id..."
            gh api -X DELETE "repos/$REPO/releases/$release_id"

            # Create new release
            echo "  Creating release..."
            cmd=(gh release create "$tag" --repo "$REPO")
            cmd+=(--title "${name:-$tag}")
            cmd+=(--notes-file /tmp/body.md)
            [ "$is_draft" = "true" ] && cmd+=(--draft)
            [ "$is_prerelease" = "true" ] && cmd+=(--prerelease)

            "${cmd[@]}"

            # Upload assets
            if [ "$(ls /tmp/assets/ 2>/dev/null | wc -l)" -gt 0 ]; then
              echo "  Uploading assets..."
              gh release upload "$tag" /tmp/assets/* --repo "$REPO" --clobber
            fi

            # Cleanup
            rm -rf /tmp/assets /tmp/body.md
            echo "  Done with $tag"
          done

          echo ""
          echo "=== All $total releases recreated ==="

      - name: Create v0.4.0 if missing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          if ! gh release view v0.4.0 --repo "$REPO" > /dev/null 2>&1; then
            echo "Creating missing v0.4.0 release..."
            gh release create v0.4.0 --repo "$REPO" --title "v0.4.0" --draft --notes "$(cat <<'NOTES'
          ## [0.4.0] - 2026-02-09

          ### Bug Fixes

          - **WebSocket reconnection loop**: eliminated a WAL checkpoint feedback loop that caused ~1s reload cycles and constant reconnection indicators
          - **Convoy badge overlap**: convoy type badges no longer overlap with status badges on wider viewports
          - **iOS/iPadOS safe area insets**: content now respects Dynamic Island, status bar, and home indicator
          - **Clipboard crash on LAN**: copying bead IDs no longer crashes on non-secure HTTP contexts
          - **WebSocket hostname**: WebSocket connects using the page hostname instead of hardcoded localhost
          - **Drag-and-drop archive**: archiving epics via drag-and-drop now works in the native macOS app
          NOTES
            )"
          else
            echo "v0.4.0 already exists, skipping"
          fi

      - name: Verify
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Release authors:"
          gh api repos/${{ github.repository }}/releases --paginate \
            --jq '.[] | [.tag_name, .author.login] | @tsv' | sort -V
