name: Recreate releases as org identity

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  recreate:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - uses: actions/checkout@v4

      - name: Recreate all releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          REPO="${{ github.repository }}"

          # Get all releases as JSON array with IDs (oldest first)
          gh api "repos/$REPO/releases" --paginate \
            --jq 'reverse | .[] | [.id, .tag_name, .name, .draft, .prerelease, (.assets | length), .body] | @json' \
            > /tmp/releases.jsonl

          total=$(wc -l < /tmp/releases.jsonl | tr -d ' ')
          echo "Found $total releases to recreate"

          count=0
          while IFS= read -r line; do
            count=$((count + 1))

            release_id=$(echo "$line" | jq -r '.[0]')
            tag=$(echo "$line" | jq -r '.[1]')
            name=$(echo "$line" | jq -r '.[2]')
            is_draft=$(echo "$line" | jq -r '.[3]')
            is_prerelease=$(echo "$line" | jq -r '.[4]')
            asset_count=$(echo "$line" | jq -r '.[5]')
            body=$(echo "$line" | jq -r '.[6]')

            echo ""
            echo "=== [$count/$total] $tag (id=$release_id, assets=$asset_count) ==="

            # Download assets if any
            rm -rf /tmp/assets && mkdir -p /tmp/assets
            if [ "$asset_count" -gt 0 ]; then
              echo "  Downloading assets..."
              # Download via API using asset URLs (tag-based download may fail)
              gh api "repos/$REPO/releases/$release_id/assets" --paginate --jq '.[] | [.name, .url] | @tsv' | \
              while IFS=$'\t' read -r asset_name asset_url; do
                echo "    $asset_name"
                gh api "$asset_url" -H "Accept: application/octet-stream" > "/tmp/assets/$asset_name" || echo "    WARN: failed to download $asset_name"
              done
              echo "  Downloaded: $(ls /tmp/assets/ | wc -l | tr -d ' ') files"
            fi

            # Delete the old release
            echo "  Deleting release..."
            gh api -X DELETE "repos/$REPO/releases/$release_id"

            # Create new release
            echo "  Creating release..."
            create_flags="--tag $tag --title ${name:-$tag}"
            [ "$is_draft" = "true" ] && create_flags="$create_flags --draft"
            [ "$is_prerelease" = "true" ] && create_flags="$create_flags --prerelease"

            if [ -n "$body" ] && [ "$body" != "null" ]; then
              printf '%s' "$body" > /tmp/body.md
              gh release create $create_flags --notes-file /tmp/body.md --repo "$REPO"
            else
              gh release create $create_flags --notes "" --repo "$REPO"
            fi

            # Upload assets
            if [ "$(ls /tmp/assets/ 2>/dev/null | wc -l)" -gt 0 ]; then
              echo "  Uploading assets..."
              gh release upload "$tag" /tmp/assets/* --repo "$REPO" --clobber
            fi

            # Cleanup
            rm -rf /tmp/assets /tmp/body.md
            echo "  Done with $tag"

          done < /tmp/releases.jsonl

          echo ""
          echo "=== All $total releases recreated ==="
